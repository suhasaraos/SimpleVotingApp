name: Dependency Update Check

on:
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  check-dependencies:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Check for outdated packages
      id: outdated
      run: |
        echo "Checking for outdated packages..."
        dotnet list VotingApp/VotingApp.sln package --outdated > outdated-packages.txt
        cat outdated-packages.txt
        
    - name: Check for vulnerable packages
      id: vulnerable
      run: |
        echo "Checking for vulnerable packages..."
        dotnet list VotingApp/VotingApp.sln package --vulnerable --include-transitive > vulnerable-packages.txt
        cat vulnerable-packages.txt
        
    - name: Create issue if updates available
      if: always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const outdated = fs.readFileSync('outdated-packages.txt', 'utf8');
          const vulnerable = fs.readFileSync('vulnerable-packages.txt', 'utf8');
          
          const hasOutdated = outdated.includes('has newer versions available');
          const hasVulnerable = vulnerable.includes('has the following vulnerable packages');
          
          if (hasOutdated || hasVulnerable) {
            const issueBody = `## Dependency Update Report
            
            This is an automated report of outdated and vulnerable dependencies.
            
            ${hasOutdated ? '### ðŸ“¦ Outdated Packages\n\n```\n' + outdated + '\n```\n' : ''}
            ${hasVulnerable ? '### âš ï¸ Vulnerable Packages\n\n```\n' + vulnerable + '\n```\n' : ''}
            
            ### Recommendations
            
            - Review the outdated packages and consider updating to the latest versions
            - Address any vulnerable packages immediately
            - Test thoroughly after updating dependencies
            
            Generated on: ${new Date().toISOString()}
            `;
            
            // Check if an issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'dependencies',
              state: 'open'
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('Weekly Dependency Update Check')
            );
            
            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: issueBody
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Weekly Dependency Update Check - ${new Date().toISOString().split('T')[0]}`,
                body: issueBody,
                labels: ['dependencies', 'maintenance']
              });
            }
          }
