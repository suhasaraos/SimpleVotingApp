name: Nightly Build

on:
  schedule:
    # Run every night at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  nightly-build:
    name: Nightly Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
        
    - name: Restore dependencies
      run: dotnet restore VotingApp/VotingApp.sln
      
    - name: Build
      run: dotnet build VotingApp/VotingApp.sln --configuration Release --no-restore
      
    - name: Run all tests
      run: dotnet test VotingApp/VotingApp.sln --configuration Release --no-build --verbosity detailed
      
    - name: Run integration tests
      run: |
        echo "Running integration tests..."
        # Add integration test commands here if available
        
    - name: Run performance tests
      run: |
        echo "Running performance tests..."
        # Add performance test commands here if available
        
    - name: Create nightly build artifact
      run: dotnet publish VotingApp/VotingApp/VotingApp.csproj --configuration Release --output ./nightly-build
      
    - name: Upload nightly build
      uses: actions/upload-artifact@v4
      with:
        name: nightly-build-${{ github.run_number }}
        path: ./nightly-build
        retention-days: 7
        
    - name: Notify on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `Nightly Build Failed - ${new Date().toISOString().split('T')[0]}`,
            body: `The nightly build failed. Please check the [workflow run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`,
            labels: ['bug', 'nightly-build']
          });
